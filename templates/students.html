{% extends "base.html" %}
{% block content %}

<!-- ================= TITLE ================= -->
<div class="text-center mb-4">
  <h3 class="fw-bold">ğŸ“Š Registered Placement Students</h3>
  <p class="text-muted">Filter â€¢ Search â€¢ Download â€¢ Manage ğŸ’¼</p>
</div>

<!-- ================= SUMMARY ================= -->
<div class="glass-card p-3 mb-4 text-center shadow-sm">
  <span class="badge bg-dark me-2 mb-2">
    ğŸ‘¥ Total : {{ students|length }}
  </span>

  {% for branch, count in branch_counts.items() %}
    <span class="badge bg-primary me-2 mb-2 px-3 py-2">
      {{ branch }} : {{ count }}
    </span>
  {% endfor %}
</div>

<!-- ================= CONTROLS ================= -->
<div class="d-flex flex-wrap justify-content-between align-items-center gap-3 mb-4">

  <!-- âœ… DOWNLOAD (SYNCED WITH FILTERS) -->
  <a class="btn btn-success"
     href="{{ url_for('download', **request.args) }}">
     â¬‡ï¸ Download Excel
  </a>

  <!-- SEARCH -->
  <div class="flex-grow-1">
    <input type="text"
           id="searchInput"
           class="form-control form-control-lg"
           placeholder="ğŸ” Search by Name or Roll">
  </div>

  <!-- FILTER -->
  <div class="position-relative">
    <button id="filterBtn" class="btn btn-info btn-lg text-white">
      âš™ Filter
    </button>

    <div id="filterMenu"
         class="glass-card position-absolute end-0 mt-2 p-2 shadow"
         style="display:none; width:300px; z-index:1000;">

      <div class="list-group list-group-flush">

        <!-- B.TECH FILTER -->
        <div class="list-group-item fw-bold text-muted">ğŸ“ B.Tech %</div>
        {% for p in [60,65,70,75,80,85,90] %}
          <label class="list-group-item">
            <input type="checkbox" class="form-check-input me-2 percent-filter" value="{{ p }}">
            Above {{ p }}%
          </label>
        {% endfor %}

        <!-- BRANCH FILTER -->
        <div class="list-group-item fw-bold text-muted">ğŸ« Branch</div>
        {% for branch in branch_counts.keys() %}
          <label class="list-group-item">
            <input type="checkbox" class="form-check-input me-2 branch-filter" value="{{ branch }}">
            {{ branch }}
          </label>
        {% endfor %}

        <!-- GENDER FILTER -->
        <div class="list-group-item fw-bold text-muted">âš§ Gender</div>
        <label class="list-group-item">
          <input type="checkbox" class="form-check-input me-2 gender-filter" value="Male">
          ğŸ‘¨ Male
        </label>
        <label class="list-group-item">
          <input type="checkbox" class="form-check-input me-2 gender-filter" value="Female">
          ğŸ‘© Female
        </label>

        <!-- BACKLOG FILTER -->
       <div class="list-group-item fw-bold text-muted">ğŸ“‰ Backlogs</div>

<label class="list-group-item">
  <input type="radio" name="max_backlogs" value="0">
  âœ… Zero Backlogs Only
</label>

<label class="list-group-item">
  <input type="radio" name="max_backlogs" value="1">
  Up to 1 Backlog
</label>

<label class="list-group-item">
  <input type="radio" name="max_backlogs" value="2">
  Up to 2 Backlogs
</label>

<label class="list-group-item">
  <input type="radio" name="max_backlogs" value="3">
  Up to 3 Backlogs
</label>



        <!-- ACTIONS -->
        <div class="d-grid gap-2 mt-2">
          <button type="button" class="btn btn-primary" onclick="applyFilters()">Apply Filters</button>
          <button class="btn btn-outline-danger" onclick="resetFilters()">Reset</button>
        </div>

      </div>
    </div>
  </div>

</div>

<!-- ================= TABLE ================= -->
<div class="glass-card p-4 shadow-lg">
  <div class="table-responsive">
    <table class="table table-hover align-middle text-center" id="studentsTable">

      <thead class="table-dark">
        <tr>
          <th>Student Name</th>
          <th>Roll Number</th>
          <th>Branch</th>
          <th>Gender</th>
          <th>Email</th>
          <th>Mobile Number</th>
          <th>X %</th>
          <th>Intermediate %</th>
          <th>B.Tech %</th>
          <th>Backlogs</th>
          <th>Action</th>
        </tr>
      </thead>

      <tbody>
        {% for student in students %}
        <tr class="{% if student.backlogs == 0 %}table-success{% endif %}">
          <td>{{ student.name }}</td>
          <td>{{ student.roll }}</td>
          <td>{{ student.branch }}</td>
          <td>{{ student.gender }}</td>
          <td>{{ student.email }}</td>
          <td>{{ student.mobile }}</td>
          <td>{{ student.tenth_percentage }}</td>
          <td>{{ student.inter_percentage }}</td>
          <td class="fw-bold">
            {{ "%.2f"|format(student.btech_percentage) }}
          </td>
          <td>
            {% if student.backlogs == 0 %}
              <span class="badge bg-success">0 ğŸ‰</span>
            {% else %}
              {{ student.backlogs }}
            {% endif %}
          </td>
          <td>
            <a href="/edit/{{ student.id }}" class="btn btn-warning btn-sm me-1">âœï¸</a>
            <a href="/delete/{{ student.id }}"
               onclick="return confirm('Are you sure you want to delete the student details?')"
               class="btn btn-danger btn-sm">ğŸ—‘ï¸</a>
          </td>
        </tr>
        {% endfor %}
      </tbody>

    </table>
  </div>
</div>

<!-- ================= BACK ================= -->
<div class="text-center mt-4">
  <a href="{{ url_for('register') }}" class="btn btn-outline-secondary btn-lg">
    â¬… Back to Registration
  </a>
</div>

<!-- ================= SCRIPT ================= -->
<script>
const filterBtn = document.getElementById("filterBtn");
const filterMenu = document.getElementById("filterMenu");

filterBtn.onclick = () => {
  filterMenu.style.display = filterMenu.style.display === "none" ? "block" : "none";
};


function applyFilters() {
  let params = new URLSearchParams();

  // B.Tech %
  document.querySelectorAll(".percent-filter:checked").forEach(cb => {
    params.append("percent", cb.value);
  });

  // Branch
  document.querySelectorAll(".branch-filter:checked").forEach(cb => {
    params.append("branch", cb.value);
  });

  // Gender
  document.querySelectorAll(".gender-filter:checked").forEach(cb => {
    params.append("gender", cb.value);
  });

  // Backlogs (radio)
  const backlog = document.querySelector('input[name="max_backlogs"]:checked');
  if (backlog) {
    params.append("max_backlogs", backlog.value);
  }

  // Redirect
  window.location.href = "/students?" + params.toString();
}


function resetFilters() {
  window.location.href = "/students";
}

/* SEARCH */
document.getElementById("searchInput").addEventListener("keyup", function () {
  const value = this.value.toLowerCase();
  document.querySelectorAll("#studentsTable tbody tr").forEach(row => {
    row.style.display = row.innerText.toLowerCase().includes(value) ? "" : "none";
  });
});
</script>

{% endblock %}
